{{- if and .Values.lokiStack.enabled (eq .Values.lokiStack.s3.type "odf") .Values.lokiStack.s3.odf.enabled .Values.lokiStack.s3.odf.secretSync.enabled }}
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ .Values.lokiStack.name }}-s3-secret-sync
  namespace: {{ .Values.lokiStack.namespace }}
  annotations:
    argocd.argoproj.io/sync-wave: "2"
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: {{ .Values.lokiStack.name }}-s3-secret-sync
  namespace: {{ .Values.lokiStack.namespace }}
  annotations:
    argocd.argoproj.io/sync-wave: "2"
rules:
- apiGroups: [""]
  resources: ["secrets", "configmaps"]
  verbs: ["get", "list", "watch", "create", "update", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: {{ .Values.lokiStack.name }}-s3-secret-sync
  namespace: {{ .Values.lokiStack.namespace }}
  annotations:
    argocd.argoproj.io/sync-wave: "2"
subjects:
- kind: ServiceAccount
  name: {{ .Values.lokiStack.name }}-s3-secret-sync
  namespace: {{ .Values.lokiStack.namespace }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: {{ .Values.lokiStack.name }}-s3-secret-sync
---
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Values.lokiStack.name }}-s3-secret-sync
  namespace: {{ .Values.lokiStack.namespace }}
  annotations:
    argocd.argoproj.io/sync-wave: "2"
spec:
  backoffLimit: 3
  ttlSecondsAfterFinished: 600
  template:
    spec:
      restartPolicy: OnFailure
      serviceAccountName: {{ .Values.lokiStack.name }}-s3-secret-sync
      containers:
      - name: sync
        image: {{ .Values.lokiStack.s3.odf.secretSync.image }}
        command:
        - /bin/bash
        - -c
        args:
        - |
          set -euo pipefail
          NAMESPACE="{{ .Values.lokiStack.namespace }}"
          OBC_NAME="{{ .Values.lokiStack.s3.odf.bucketName }}"
          TARGET_SECRET="{{ default (printf "%s-s3" .Values.lokiStack.name) .Values.lokiStack.s3.secretName }}"
          POLL_INTERVAL="{{ .Values.lokiStack.s3.odf.secretSync.pollIntervalSeconds }}"
          MAX_ATTEMPTS="{{ .Values.lokiStack.s3.odf.secretSync.maxAttempts }}"

          attempt=1
          while [ "$attempt" -le "$MAX_ATTEMPTS" ]; do
            if oc get secret "$OBC_NAME" -n "$NAMESPACE" >/dev/null 2>&1 && oc get configmap "$OBC_NAME" -n "$NAMESPACE" >/dev/null 2>&1; then
              break
            fi
            echo "Waiting for OBC data ($attempt/$MAX_ATTEMPTS): secret/configmap $OBC_NAME"
            sleep "$POLL_INTERVAL"
            attempt=$((attempt + 1))
          done

          if ! oc get secret "$OBC_NAME" -n "$NAMESPACE" >/dev/null 2>&1; then
            echo "OBC Secret $OBC_NAME not found in $NAMESPACE"
            exit 1
          fi
          if ! oc get configmap "$OBC_NAME" -n "$NAMESPACE" >/dev/null 2>&1; then
            echo "OBC ConfigMap $OBC_NAME not found in $NAMESPACE"
            exit 1
          fi

          ACCESS_KEY_ID=$(oc get secret "$OBC_NAME" -n "$NAMESPACE" -o jsonpath='{.data.AWS_ACCESS_KEY_ID}' | base64 -d)
          ACCESS_KEY_SECRET=$(oc get secret "$OBC_NAME" -n "$NAMESPACE" -o jsonpath='{.data.AWS_SECRET_ACCESS_KEY}' | base64 -d)
          BUCKET_NAME=$(oc get configmap "$OBC_NAME" -n "$NAMESPACE" -o jsonpath='{.data.BUCKET_NAME}')
          BUCKET_HOST=$(oc get configmap "$OBC_NAME" -n "$NAMESPACE" -o jsonpath='{.data.BUCKET_HOST}')
          BUCKET_PORT=$(oc get configmap "$OBC_NAME" -n "$NAMESPACE" -o jsonpath='{.data.BUCKET_PORT}')

          if [ "{{ .Values.lokiStack.s3.odf.secretSync.useHttpsEndpoint }}" = "true" ]; then
            ENDPOINT="https://${BUCKET_HOST}:${BUCKET_PORT}"
          else
            ENDPOINT="http://${BUCKET_HOST}:80"
          fi

          oc create secret generic "$TARGET_SECRET" -n "$NAMESPACE" \
            --from-literal=access_key_id="$ACCESS_KEY_ID" \
            --from-literal=access_key_secret="$ACCESS_KEY_SECRET" \
            --from-literal=bucketnames="$BUCKET_NAME" \
            --from-literal=endpoint="$ENDPOINT" \
            --dry-run=client -o yaml | oc apply -f -

          echo "Secret $TARGET_SECRET synchronized successfully"
{{- end }}
