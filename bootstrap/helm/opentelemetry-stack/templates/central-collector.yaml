apiVersion: opentelemetry.io/v1beta1
kind: OpenTelemetryCollector
metadata:
  name: {{ .Values.centralCollector.name }}
  namespace: {{ .Values.namespace }}
  annotations:
    argocd.argoproj.io/sync-wave: "3"
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
spec:
  # Deployment mode with multiple replicas
  mode: deployment
  replicas: {{ .Values.centralCollector.replicas }}
  
  # Service account with Tempo write permissions
  serviceAccount: {{ .Values.serviceAccounts.central }}
  
  # OpenTelemetry Collector configuration
  config:
    # Extensions
    extensions:
      # Bearer token authentication for Tempo
      bearertokenauth:
        filename: /var/run/secrets/kubernetes.io/serviceaccount/token
    
    # Receivers - accept telemetry from sidecar collectors
    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
          http:
            endpoint: 0.0.0.0:4318
    
    {{- if .Values.centralCollector.spanmetrics.enabled }}
    # Connectors - generate metrics from traces
    connectors:
      spanmetrics:
        # Histogram buckets for latency metrics
        histogram:
          explicit:
            buckets:
              {{- range .Values.centralCollector.spanmetrics.histogramBuckets }}
              - {{ . }}
              {{- end }}
        # Dimensions to extract from spans
        dimensions:
          {{- range .Values.centralCollector.spanmetrics.dimensions }}
          - name: {{ .name }}
          {{- end }}
        # Enable exemplars for trace-metric correlation
        exemplars:
          enabled: {{ .Values.centralCollector.spanmetrics.exemplarsEnabled }}
        # Metrics flush interval
        metrics_flush_interval: {{ .Values.centralCollector.spanmetrics.flushInterval }}
    {{- end }}
    
    # Processors - enrich and transform telemetry
    processors:
      # Memory limiter to prevent OOM
      memory_limiter:
        check_interval: 1s
        limit_mib: {{ .Values.centralCollector.memoryLimit }}
        spike_limit_mib: 200
      
      # Resource detection - OpenShift metadata
      resourcedetection:
        detectors:
        - openshift
        timeout: 2s
      
      # Kubernetes attributes - pod, namespace, etc.
      k8sattributes:
        auth_type: serviceAccount
        passthrough: false
        extract:
          metadata:
          - k8s.namespace.name
          - k8s.deployment.name
          - k8s.statefulset.name
          - k8s.daemonset.name
          - k8s.cronjob.name
          - k8s.job.name
          - k8s.node.name
          - k8s.pod.name
          - k8s.pod.uid
          - k8s.pod.start_time
      
      {{- if .Values.centralCollector.spanmetrics.enabled }}
      # Transform spanmetrics metric names
      metricstransform:
        transforms:
        - include: calls_total
          match_type: strict
          action: update
          new_name: traces_spanmetrics_calls_total
        - include: latency
          match_type: strict
          action: update
          new_name: traces_spanmetrics_latency
      {{- end }}
      
      # Batch processor for efficiency
      batch:
        timeout: 10s
        send_batch_size: 1024
    
    # Exporters - send telemetry to backends
    exporters:
      # Tempo exporter for traces
      otlp/tempo:
        endpoint: {{ .Values.centralCollector.tempo.endpoint }}
        tls:
          ca_file: {{ .Values.centralCollector.tempo.caFile }}
          insecure: false
        auth:
          authenticator: bearertokenauth
        headers:
          X-Scope-OrgID: {{ .Values.centralCollector.tempo.tenant }}
      
      # Prometheus remote write for metrics
      prometheusremotewrite:
        endpoint: {{ .Values.centralCollector.prometheus.endpoint }}
        resource_to_telemetry_conversion:
          enabled: true
      
      # Debug exporter for troubleshooting
      debug:
        verbosity: basic
    
    # Service configuration
    service:
      # Extensions
      extensions:
      - bearertokenauth
      
      # Pipelines
      pipelines:
        # Traces pipeline - send to Tempo and spanmetrics connector
        traces:
          receivers:
          - otlp
          processors:
          - memory_limiter
          - resourcedetection
          - k8sattributes
          - batch
          exporters:
          - otlp/tempo
          {{- if .Values.centralCollector.spanmetrics.enabled }}
          - spanmetrics
          {{- end }}
        
        {{- if .Values.centralCollector.spanmetrics.enabled }}
        # Spanmetrics pipeline - RED metrics from traces
        traces/spanmetrics:
          receivers:
          - spanmetrics
          processors:
          - metricstransform
          - batch
          exporters:
          - prometheusremotewrite
        {{- end }}
        
        # Metrics pipeline - send to Prometheus
        metrics:
          receivers:
          - otlp
          processors:
          - memory_limiter
          - resourcedetection
          - k8sattributes
          - batch
          exporters:
          - prometheusremotewrite
        
        # Logs pipeline - debug only
        logs:
          receivers:
          - otlp
          processors:
          - memory_limiter
          - resourcedetection
          - k8sattributes
          - batch
          exporters:
          - debug
