apiVersion: opentelemetry.io/v1alpha1
kind: Instrumentation
metadata:
  name: {{ .Values.instrumentation.name }}
  namespace: {{ .Values.namespace }}
  annotations:
    argocd.argoproj.io/sync-wave: "3"
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
spec:
  # Exporter configuration - points to sidecar collector
  exporter:
    endpoint: {{ .Values.instrumentation.exporter.endpoint }}
  
  # Sampler configuration
  sampler:
    type: {{ .Values.instrumentation.sampler.type }}
    argument: {{ .Values.instrumentation.sampler.argument | quote }}
  
  # Propagators for trace context
  propagators:
    {{- range .Values.instrumentation.propagators }}
    - {{ . }}
    {{- end }}
  
  # Python auto-instrumentation
  python:
    env:
    - name: OTEL_EXPORTER_OTLP_ENDPOINT
      value: {{ .Values.instrumentation.exporter.endpoint }}
    - name: OTEL_TRACES_EXPORTER
      value: otlp
    - name: OTEL_METRICS_EXPORTER
      value: otlp
    - name: OTEL_LOGS_EXPORTER
      value: otlp
  
  # Node.js auto-instrumentation
  nodejs:
    env:
    - name: OTEL_EXPORTER_OTLP_ENDPOINT
      value: {{ .Values.instrumentation.exporter.endpoint }}
    - name: OTEL_TRACES_EXPORTER
      value: otlp
    - name: OTEL_METRICS_EXPORTER
      value: otlp
    - name: OTEL_LOGS_EXPORTER
      value: otlp
  
  # Java/Quarkus auto-instrumentation
  java:
    env:
    - name: OTEL_EXPORTER_OTLP_ENDPOINT
      value: {{ .Values.instrumentation.exporter.endpoint }}
    - name: OTEL_TRACES_EXPORTER
      value: otlp
    - name: OTEL_METRICS_EXPORTER
      value: otlp
    - name: OTEL_LOGS_EXPORTER
      value: otlp
  
  # Go auto-instrumentation
  go:
    env:
    - name: OTEL_EXPORTER_OTLP_ENDPOINT
      value: {{ .Values.instrumentation.exporter.endpoint }}
    - name: OTEL_TRACES_EXPORTER
      value: otlp
    - name: OTEL_METRICS_EXPORTER
      value: otlp
    - name: OTEL_LOGS_EXPORTER
      value: otlp
