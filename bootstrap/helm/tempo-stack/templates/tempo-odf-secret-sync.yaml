{{- if and (eq .Values.storage.type "odf") .Values.storage.odf.enabled .Values.storage.odf.secretSync.enabled }}
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ .Values.tempoStack.name }}-s3-secret-sync
  namespace: {{ .Values.operator.namespace }}
  annotations:
    argocd.argoproj.io/sync-wave: "2"
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: {{ .Values.tempoStack.name }}-s3-secret-sync
  namespace: {{ .Values.operator.namespace }}
  annotations:
    argocd.argoproj.io/sync-wave: "2"
rules:
- apiGroups: [""]
  resources: ["secrets", "configmaps"]
  verbs: ["get", "list", "watch", "create", "update", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: {{ .Values.tempoStack.name }}-s3-secret-sync
  namespace: {{ .Values.operator.namespace }}
  annotations:
    argocd.argoproj.io/sync-wave: "2"
subjects:
- kind: ServiceAccount
  name: {{ .Values.tempoStack.name }}-s3-secret-sync
  namespace: {{ .Values.operator.namespace }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: {{ .Values.tempoStack.name }}-s3-secret-sync
---
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Values.tempoStack.name }}-s3-secret-sync
  namespace: {{ .Values.operator.namespace }}
  annotations:
    argocd.argoproj.io/sync-wave: "2"
spec:
  backoffLimit: 3
  ttlSecondsAfterFinished: 600
  template:
    spec:
      restartPolicy: OnFailure
      serviceAccountName: {{ .Values.tempoStack.name }}-s3-secret-sync
      containers:
      - name: sync
        image: {{ .Values.storage.odf.secretSync.image }}
        command:
        - /bin/bash
        - -c
        args:
        - |
          set -euo pipefail
          NAMESPACE="{{ .Values.operator.namespace }}"
          OBC_NAME="{{ .Values.storage.odf.bucketName }}"
          TARGET_SECRET="tempo-storage"
          POLL_INTERVAL="{{ .Values.storage.odf.secretSync.pollIntervalSeconds }}"
          MAX_ATTEMPTS="{{ .Values.storage.odf.secretSync.maxAttempts }}"

          attempt=1
          while [ "$attempt" -le "$MAX_ATTEMPTS" ]; do
            if oc get secret "$OBC_NAME" -n "$NAMESPACE" >/dev/null 2>&1 && oc get configmap "$OBC_NAME" -n "$NAMESPACE" >/dev/null 2>&1; then
              break
            fi
            echo "Waiting for OBC data ($attempt/$MAX_ATTEMPTS): secret/configmap $OBC_NAME"
            sleep "$POLL_INTERVAL"
            attempt=$((attempt + 1))
          done

          if ! oc get secret "$OBC_NAME" -n "$NAMESPACE" >/dev/null 2>&1; then
            echo "OBC Secret $OBC_NAME not found in $NAMESPACE"
            exit 1
          fi
          if ! oc get configmap "$OBC_NAME" -n "$NAMESPACE" >/dev/null 2>&1; then
            echo "OBC ConfigMap $OBC_NAME not found in $NAMESPACE"
            exit 1
          fi

          ACCESS_KEY_ID=$(oc get secret "$OBC_NAME" -n "$NAMESPACE" -o jsonpath='{.data.AWS_ACCESS_KEY_ID}' | base64 -d)
          ACCESS_KEY_SECRET=$(oc get secret "$OBC_NAME" -n "$NAMESPACE" -o jsonpath='{.data.AWS_SECRET_ACCESS_KEY}' | base64 -d)
          BUCKET_NAME=$(oc get configmap "$OBC_NAME" -n "$NAMESPACE" -o jsonpath='{.data.BUCKET_NAME}')
          BUCKET_HOST=$(oc get configmap "$OBC_NAME" -n "$NAMESPACE" -o jsonpath='{.data.BUCKET_HOST}')
          BUCKET_PORT=$(oc get configmap "$OBC_NAME" -n "$NAMESPACE" -o jsonpath='{.data.BUCKET_PORT}')

          if [ "{{ .Values.storage.odf.secretSync.useHttpsEndpoint }}" = "true" ]; then
            ENDPOINT="https://${BUCKET_HOST}:${BUCKET_PORT}"
          else
            ENDPOINT="http://${BUCKET_HOST}:80"
          fi

          # TempoStack expects: bucket, endpoint, access_key_id, access_key_secret
          oc create secret generic "$TARGET_SECRET" -n "$NAMESPACE" \
            --from-literal=bucket="$BUCKET_NAME" \
            --from-literal=endpoint="$ENDPOINT" \
            --from-literal=access_key_id="$ACCESS_KEY_ID" \
            --from-literal=access_key_secret="$ACCESS_KEY_SECRET" \
            --dry-run=client -o yaml | oc apply -f -

          echo "Secret $TARGET_SECRET synchronized successfully"
{{- end }}
